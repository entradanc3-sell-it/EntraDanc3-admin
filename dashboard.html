<!DOCTYPE html><html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>EntraDanc3 · Panel</title>
<link rel="stylesheet" href="styles.css">
<style>
:root { --red:#a20505; --bg:#0b0b0b; --card:#171717; --text:#eaeaea; --muted:#9a9a9a; }
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:32px auto;padding:0 16px}
h1{margin:0 0 12px;font-size:32px}
.sub{margin:0 0 20px;color:var(--muted)}
.card{background:var(--card);border:1px solid #222;border-radius:12px;padding:16px}
label{display:block;margin:10px 0 6px;font-weight:600}
input,select,textarea{width:100%;background:#111;border:1px solid #2a2a2a;color:var(--text);padding:10px;border-radius:10px}
textarea{min-height:110px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.btn{background:var(--red);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#2a2a2a}
.btn.sm{padding:6px 10px;border-radius:8px}
.row{display:flex;gap:8px;align-items:center;margin:6px 0}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{padding:10px;border-bottom:1px solid #262626;text-align:left}
a{color:#fff}
.top{display:flex;justify-content:space-between;align-items:center}
.right a{color:#fff;text-decoration:underline}
.badge{background:#2b2b2b;border-radius:999px;padding:4px 10px;font-size:12px;color:#bdbdbd}
</style>

<!-- Carga tu config -->
<script src="config.js?v=4"></script>
<!-- Firebase CDN v10 -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { 
  getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, updateDoc, onSnapshot, serverTimestamp 
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

if(!window.FB_CONFIG){ alert('No se cargó config.js'); throw new Error('config faltante'); }

const app  = initializeApp(window.FB_CONFIG);
const auth = getAuth(app);
const db   = getFirestore(app);

// UI refs
const $ = s=>document.querySelector(s);
const form = {
  slug:    $('#slug'),
  title:   $('#title'),
  date:    $('#date'),
  city:    $('#city'),
  venue:   $('#venue'),
  cat:     $('#cat'),
  thumb:   $('#thumb'),
  desc:    $('#desc'),
  sectors: $('#sectors'),
  save:    $('#save'),
  del:     $('#del'),
  view:    $('#view'),
  msg:     $('#msg')
};

// auth gate
onAuthStateChanged(auth, u=>{
  if(!u){ location.href='login.html'; return; }
  if(u.uid !== window.ADMIN_UID){ alert('No sos admin.'); signOut(auth); return; }
  $('#who').textContent = '✔ Sesión: '+u.email;
  bind();
  liveList();
});

$('#logout').onclick = async()=>{ await signOut(auth); location.href='login.html'; };

// ------- sectores -------
function addSectorRow(s={name:'',price:'',mp_link:''}){
  const wrap = document.createElement('div'); wrap.className='row';
  wrap.innerHTML = `
    <input class="s-name"  placeholder="Nombre (General, VIP...)" value="${s.name||''}">
    <input class="s-price" type="number" min="0" step="1" placeholder="Precio" value="${s.price||''}">
    <input class="s-link"  placeholder="Link MP (https://...)" value="${s.mp_link||''}">
    <button type="button" class="btn sm secondary">Eliminar</button>
  `;
  wrap.querySelector('button').onclick = ()=> wrap.remove();
  form.sectors.appendChild(wrap);
}

$('#add-sector').onclick = ()=> addSectorRow();

function collectSectors(){
  const rows = [...form.sectors.querySelectorAll('.row')];
  return rows.map(r=>({
    name: r.querySelector('.s-name').value.trim(),
    price: Number(r.querySelector('.s-price').value || 0),
    mp_link: r.querySelector('.s-link').value.trim()
  })).filter(s=>s.name);
}

// ------- guardar / eliminar -------
async function save(){
  try{
    form.msg.textContent = 'Guardando...';
    const slug = form.slug.value.trim();
    if(!slug) throw new Error('Slug requerido');
    const data = {
      title: form.title.value.trim(),
      date:  new Date(form.date.value),
      city:  form.city.value.trim(),
      venue: form.venue.value.trim(),
      category: form.cat.value,
      thumb: form.thumb.value.trim(),
      desc:  form.desc.value.trim(),
      sectors: collectSectors(),
      updatedAt: serverTimestamp()
    };
    await setDoc(doc(db,'events',slug), data, { merge:true });
    form.msg.textContent = '✔ Guardado';
    loadList();
  }catch(e){
    console.error(e);
    form.msg.textContent = 'Error: '+(e.message||e);
  }
}

async function remove(){
  const slug = form.slug.value.trim();
  if(!slug) return;
  if(!confirm('Eliminar "'+slug+'"?')) return;
  await deleteDoc(doc(db,'events',slug));
  form.msg.textContent = '✔ Eliminado';
  clearForm();
  loadList();
}

function clearForm(){
  form.slug.value=''; form.title.value=''; form.date.value='';
  form.city.value=''; form.venue.value=''; form.cat.value='fiestas';
  form.thumb.value=''; form.desc.value=''; form.sectors.innerHTML='';
}

function editFromRow(slug){
  return async ()=>{
    const snap = await getDoc(doc(db,'events',slug));
    if(!snap.exists()) return;
    const d = snap.data();
    form.slug.value = slug;
    form.title.value = d.title||'';
    form.date.value  = d.date ? new Date(d.date.seconds*1000).toISOString().slice(0,10) : '';
    form.city.value  = d.city||'';
    form.venue.value = d.venue||'';
    form.cat.value   = d.category||'fiestas';
    form.thumb.value = d.thumb||'';
    form.desc.value  = d.desc||'';
    form.sectors.innerHTML = '';
    (d.sectors||[]).forEach(addSectorRow);
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

// ------- listado -------
async function loadList(){
  const tbody = $('#tbody'); tbody.innerHTML='';
  const qs = await getDocs(collection(db,'events'));
  const arr = [];
  qs.forEach(d=>arr.push({slug:d.id, ...d.data()}));
  arr.sort((a,b)=> (a.date?.seconds||0) - (b.date?.seconds||0));
  arr.forEach((ev)=>{
    const tr = document.createElement('tr');
    const f  = ev.date? new Date(ev.date.seconds*1000).toLocaleDateString('es-AR') : '';
    tr.innerHTML = `
      <td>${ev.slug||ev.title}</td>
      <td>${ev.title||''}</td>
      <td>${f}</td>
      <td><span class="badge">${ev.category||''}</span></td>
      <td>
        <button class="btn sm secondary edit">Editar</button>
        <a class="btn sm" target="_blank" href="../evento.html?id=${ev.slug||''}">Ver</a>
      </td>`;
    tr.querySelector('.edit').onclick = editFromRow(ev.slug||'');
    tbody.appendChild(tr);
  });
}
function liveList(){ onSnapshot(collection(db,'events'), loadList); }

function bind(){
  form.save.onclick = save;
  form.del.onclick  = remove;
  form.view.onclick = ()=> {
    const s = form.slug.value.trim(); 
    if(s) window.open('../evento.html?id='+s,'_blank');
  };
}

</script>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>Panel de control</h1>
      <div class="right">
        <span id="who" class="badge">Cargando…</span> · <a href="#" id="logout">Salir</a>
      </div>
    </div>
    <p class="sub">Sólo el UID admin puede modificar. Lectura pública.</p>

    <div class="card">
      <h3>Nuevo/Editar evento</h3>
      <div class="grid">
        <div>
          <label>Slug (único, url)</label>
          <input id="slug" placeholder="space-92-crobar-2025-08-22">
        </div>
        <div>
          <label>Título</label>
          <input id="title" placeholder="Space 92 – Crobar Phuture">
        </div>
        <div>
          <label>Fecha</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Ciudad</label>
          <input id="city" placeholder="Buenos Aires">
        </div>
        <div>
          <label>Lugar</label>
          <input id="venue" placeholder="Crobar Phuture">
        </div>
        <div>
          <label>Categoría</label>
          <select id="cat">
            <option value="fiestas">fiestas</option>
            <option value="recitales">recitales</option>
            <option value="futbol">futbol</option>
          </select>
        </div>
        <div class="grid" style="grid-template-columns:1fr">
          <label>Thumbnail (URL de imagen)</label>
          <input id="thumb" placeholder="https://...">
        </div>
        <div class="grid" style="grid-template-columns:1fr">
          <label>Descripción</label>
          <textarea id="desc" placeholder="Texto del evento..."></textarea>
        </div>
      </div>

      <label style="margin-top:8px">Sectores (nombre, precio, link MP)</label>
      <div id="sectors"></div>
      <button id="add-sector" class="btn secondary" type="button">+ Agregar sector</button>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button id="save" class="btn" type="button">Guardar</button>
        <button id="del" class="btn secondary" type="button">Eliminar</button>
        <button id="view" class="btn secondary" type="button">Ver público</button>
        <div id="msg" class="sub"></div>
      </div>
    </div>

    <h3 style="margin:18px 0 6px">Eventos cargados</h3>
    <div class="card">
      <table>
        <thead><tr><th>Slug</th><th>Título</th><th>Fecha</th><th>Categoría</th><th>Acciones</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
